### Creating Tidy Dataset from Human Activity Recognition Using Smartphones Dataset

### Usage
Requirements

* The script needs to run in R environment, such as R Studio or R console.
* It also requires the R-package 'plyr'.

Steps

1. Download the data set from http://archive.ics.uci.edu/ml/datasets/Human+Activity+Recognition+Using+Smartphones and unzip it to a local folder.
2. Set the working directory in R environment to the dataset folder, which includes the file 'README.txt'.
3. In R environment, execute the script run_analysis.R by the source() function.
4. It will create a file named tidy_dataset.txt in the dataset folder.

### 1 Introduction
The purpose of this project is to create a tidy data set from the Human Activity Recognition Using Smartphones Dataset [1].  In the experiment, there are 30 subjects(volunteers) each wearing a smartphone on the waist, performing six activities (WALKING, WALKING_UPSTAIRS, WALKING_DOWNSTAIRS, SITTING, STANDING, LAYING).  Signals from embedded sensors (accelerometer and gyroscope) are sampled at 50Hz and recorded.  The raw signals are first filtered to remove noise and then split by a sliding window of 2.56 seconds (128 samples) with 50% overlap.  Then a feature vector is calculated for a window.  The features of one sliding window is stored in one row of data file.

#### 1.1 Data organization
In the dataset folder, there are two directories, train and test, each contains three data files: 

* X: numeric, values of 561 features, one column per feature.
* y: 1-6, representing the six activities. 
* subject: 1-30, id of 30 subjects

There is also a sub-directory "Inertial Signals" contains the raw data.  We only use the features in X to create tidy dataset since they are less noisy and should capture sufficient information of the raw data.


#### 1.2 Variables
In the following, some variables denoted by '-XYZ'.  This notation represents a set of three-axial signals in the X, Y and Z directions.
The basic set of variables includes

* tGravityAcc-XYZ: time-domain gravity acceleration.  It is the lowpass-filtered output of the total acceleration.
* tBodyAcc-XYZ: time-domain body acceleration.  It is the residual signal after removing gravity acceleration from total acceleration.
* tBodyAccJerk-XYZ: time-domain Jerk signal of body acceleration.  It is the time-derivative of tBodyAcc-XYZ.
* tBodyGyro-XYZ: time-domain body angular velocity.
* tBodyGyroJerk-XYZ: time-domain Jerk signal of body angular velocity.  It is the time-derivative of tBodyGyro-XYZ.
* tBodyAccMag: magnitude of the corresponding 3-dimensional signal tBodyAcc-XYZ.  It is similar to tGravityAccMag, tBodyAccJerkMag, tBodyGyroMag, tBodyGyroJerkMag.
* fBodyAcc-XYZ: frequency-domain signal by applying Fast Fourier Transform (FFT) to the corresponding time-domain signal tBodyAcc-XYZ.  It is similar to fBodyAccJerk-XYZ, fBodyGyro-XYZ, fBodyAccMag, fBodyAccJerkMag, fBodyGyroMag, fBodyGyroJerkMag.  The prefix 'f' denotes the frequency-domain signals.

An item with '-XYZ' is counted as 3 variables, and the basic set includes 33 variables.

In the original dataset, many processes are applied to the basic set of variables to generated a large set of 561 features.  Among them, we are only interested in the features by applying 'mean()' or 'std()' to the basic set of variables.

### 2 Data Clean Up

#### 2.1 Features selection
There are 561 features in X, but we are only interested in the features generated by 'mean()' or 'std()' measures.  Features names are read from the features.txt file and then matched to target pattern to form the column selection vector.

```
features <- read.table("features.txt")
column.select <- grepl("(mean|std)\\(\\)",(features$V2))
```

#### 2.2 Features renaming
The feature name are slightly modified.  The punctuation characters around "mean" or "std" are removed, and the first character of "mean" or "std" is capitalized.  For example the substrings '-mean()-' is replaced by 'Mean'.  Some features strangely have repeated "Body" in their names, such as "fBodyBodyAccJerkMag".  These are also fixed with a single "Body".

```
names.select <- features$V2[column.select]
names.select <- sub("[[:punct:]]+mean[[:punct:]]+", "Mean", names.select)
names.select <- sub("[[:punct:]]+std[[:punct:]]+", "Std", names.select)
names.select <- sub("BodyBody", "Body", names.select)
```

#### 2.3 Data merge
For the firs step, a function 'read.dir.data()' is defined to read data files in a directory and combing them into a data frame.  Because file X is large and reading is slow, we set the 'colClasses' vector with "NULL" for unused columns and "numeric" for target columns.  The unused columns will be skipped by 'read.table()', and the reading data from file greatly speeds up.  In the new data frame, the first two columns are activity and subject, while the remaining columns are the selected features.

```
colClasses <- rep("NULL",length(column.select))
colClasses[column.select] <- "numeric"

read.dir.data <- function(name) {
  y <- read.table(file.path(name, paste0("y_",name,".txt")), nrows=nrows)
  x <- read.table(file.path(name, paste0("X_",name,".txt")), nrows=nrows, colClasses=colClasses)
  subject <- read.table(file.path(name, paste0("subject_",name,".txt")), nrows=nrows)

  df <- data.frame(y, subject, x)
  names(df) <- c("activity","subject",names.select)
  df
}
```

For the second step, we apply 'read.dir.data()' to the two directories, 'train' and 'test'.  The result are two data frames which are further row-combined and merged into a single data frame.

```
df.list <- lapply(c("train","test"),read.dir.data)
df <- do.call(rbind,df.list)
```

#### 2.4 Meaningful labels

The integer values in the activity column are replaced by meaningful text lables.
```
activity_labels <- read.table("activity_labels.txt")
df$activity <- factor(df$activity, levels=activity_labels$V1, labels=activity_labels$V2)
```

### 3 Tidy Dataset
In the tidy dataset, we present the average of each variable for each activity and each subject.  Each row is for a combination of activity and subject.  We split the data frame 'df' by the combination of (activity, subject), calculate column means for the features, and then merge back.  The tidy dataset is output to the file 'tidy_dataset.txt'.

```
df.tidy <- ddply(df, .(activity, subject), function(x){colMeans(x[c(-1,-2)])})
write.table(df.tidy,file="tidy_dataset.txt",row.names=F, quote=F)
```
#### 3.1 Codebook

There are 180 rows for the combinations of 6 activities and 30 subjects.  In the beginning is the header line for the names of columns.  The tidy dataset has 68 columns.  The first two columns are activity and subject.  The remaining 66 columns are for selected features, based on applying 'mean()' or 'std()' to the 33 variables in the basic set.

The naming of the features is composed of the following parts.

1. t/f: time-domain or frequency-domain.
2. Gravity/Body: Gravity means the acceleration caused by Earth and is the low-frequency part of the total acceleration.  Body means the acceleration or angular velocity of human body.
3. Acc/Gyro: Acc means the linear acceleration from accelerometer.  Gyro means the angular velocity from gyroscope.
4. Jerk: time-derivative of the linear acceleration or angular velocity.
5. Mean/Std: features generated by mean() or std() from the basic set of variables.
6. Mag/X/Y/Z: X/Y/Z mean the signal along the specific axis.  Mag means the magnitude of the three-dimensional vector.

The naming basically follows the original format, and some details have been explained in section 1.2.

### 4 Reference
[1] Davide Anguita, Alessandro Ghio, Luca Oneto, Xavier Parra and Jorge L. Reyes-Ortiz. Human Activity Recognition on Smartphones using a Multiclass Hardware-Friendly Support Vector Machine. International Workshop of Ambient Assisted Living (IWAAL 2012). Vitoria-Gasteiz, Spain. Dec 2012